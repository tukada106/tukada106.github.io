<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>IR送信テストページ</title>
<style>
  body { font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background:#f9fafb; margin:0; padding:2rem; color:#333; }
  h1 { font-size:1.6rem; margin-bottom:1rem; }
  .card { background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,.1); padding:1.5rem; max-width:520px; margin:auto; }
  label { display:block; margin-top:1rem; font-weight:bold; }
  input, button { width:100%; margin-top:.5rem; padding:.6rem; font-size:1rem; border-radius:.5rem; border:1px solid #ccc; }
  button { background:#0078d7; color:#fff; border:none; cursor:pointer; transition:opacity .15s ease; }
  button:hover { background:#005fa3; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  pre { background:#111827; color:#e5e7eb; padding:1rem; border-radius:.5rem; overflow-x:auto; font-size:.9rem; margin-top:1.5rem; }
  small { color:#666; }
</style>
</head>
<body>
  <div class="card">
    <h1>IR学習リモコン テスト</h1>

    <label for="irid">IR ID（例：サーキュレーター電源）</label>
    <input id="irid" placeholder="シートの name 列と一致させてね" />

    <label for="gasurl">GAS WebアプリURL <small>※ /exec で終わるURL</small></label>
    <input id="gasurl" value="https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxx/exec" />

    <button id="btn-send" type="button">送信</button>

    <pre id="log">結果はここに表示されます</pre>
  </div>

<script>
function uuidv4(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}
function withTimeout(ms){
  const ac = new AbortController();
  const t = setTimeout(() => ac.abort(new DOMException("timeout","AbortError")), ms);
  return { signal: ac.signal, cancel: () => clearTimeout(t) };
}
function setBusy(b){
  const btn = document.getElementById("btn-send");
  btn.disabled = b;
  btn.textContent = b ? "送信中..." : "送信";
}
async function getNonce(baseUrl){
  const tm = withTimeout(8000); // ノンス取得は8秒
  try{
    const r = await fetch(baseUrl + "?op=nonce", { signal: tm.signal, referrerPolicy: "strict-origin" });
    if (!r.ok) throw new Error("nonce取得失敗: HTTP " + r.status);
    const j = await r.json();
    if (!j || !j.nonce) throw new Error("nonceが空");
    return j.nonce;
  }finally{
    tm.cancel();
  }
}

document.getElementById("btn-send").addEventListener("click", async () => {
  const gasUrl = document.getElementById("gasurl").value.trim();
  const irId   = document.getElementById("irid").value.trim();
  const log    = document.getElementById("log");

  if (!gasUrl || !irId){ log.textContent = "URLとIR IDを入力してください。"; return; }
  if (!/\/exec(\?|$)/.test(gasUrl)){ log.textContent = "GASの公開URL（/exec）を指定してください。"; return; }

  setBusy(true);
  log.textContent = "準備中...";

  try{
    // 1) Nonce（個別タイムアウト）
    const nonce = await getNonce(gasUrl);

    // 2) 本送信（15秒タイムアウト・プリフライト回避・Refererはオリジンのみ）
    log.textContent = "送信中...";
    const idem = uuidv4();
    const body = {
      ir_id: irId,
      idempotency_key: idem,
      nonce,
      client_ts: Date.now(),
      origin_hint: location.origin // 最終フォールバック用
    };

    const tm2 = withTimeout(15000); // 本送信は15秒
    let res, text;
    try{
      res  = await fetch(gasUrl, {
        method: "POST",
        body: JSON.stringify(body),        // ← Content-Typeは付けない（simple request）
        signal: tm2.signal,
        referrerPolicy: "strict-origin"    // ← Refererに https://<user>.github.io だけを送る
      });
      text = await res.text();
    }finally{
      tm2.cancel();
    }

    let parsed; try{ parsed = JSON.parse(text); }catch{ parsed = { raw: text }; }
    log.textContent = JSON.stringify({ status: res.status, body: parsed }, null, 2);
  }catch(err){
    log.textContent = "エラー: " + (err?.message || String(err));
  }finally{
    setBusy(false);
  }
});
</script>
</body>
</html>
